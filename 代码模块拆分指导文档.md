# 代码模块拆分指导文档

## 概述
本文档提供了一个系统化的方法，用于将大型 JavaScript 文件（如 index.js）拆分为多个职责明确的模块。

## 拆分原则

### 1. 单一职责原则 (SRP)
每个模块只负责一个特定的功能领域。

### 2. 依赖倒置原则
通过 require/import 明确模块间的依赖关系。

### 3. 高内聚，低耦合
- 相关功能聚集在同一模块
- 模块之间通过明确的接口交互
- 避免循环依赖

## 拆分步骤

### 步骤 1：识别功能模块
1. **分析代码结构**
   - 按功能注释分组
   - 查找相关函数的聚合
   - 识别独立的工具函数

2. **常见模块类型**
   ```
   - utils/          - 工具函数集合
   - config/         - 配置相关
   - middleware/     - 中间件
   - routes/         - 路由处理
   - models/         - 数据模型
   - services/       - 业务逻辑
   ```

### 步骤 2：创建模块文件
1. **基础模板**
   ```javascript
   // 导入依赖
   const dep = require('dep');

   // 模块内部函数（可选）
   const internalFunction = () => {};

   // 导出函数
   module.exports = {
     publicFunction1,
     publicFunction2
   };
   ```

2. **添加 JSDoc 注释**
   ```javascript
   /**
    * 函数描述
    * @param {类型} 参数名 - 参数说明
    * @returns {类型} 返回值说明
    */
   ```

### 步骤 3：迁移代码
1. **复制相关函数**
   - 保持函数签名不变
   - 添加必要的注释

2. **处理依赖**
   - 将需要的依赖添加到文件顶部
   - 确保所有变量都有定义

### 步骤 4：更新原文件
1. **导入新模块**
   ```javascript
   const { functionName } = require('./path/to/module');
   ```

2. **删除原有代码**
   - 删除已经迁移的函数
   - 清理未使用的导入

### 步骤 5：测试验证
1. 运行项目确保没有语法错误
2. 测试相关功能是否正常工作
3. 检查是否有遗漏的依赖

## 最佳实践

### 1. 文件命名规范
- 使用小写字母和连字符：`user-auth.js`
- 或者驼峰命名：`userAuth.js`
- 保持一致性

### 2. 目录结构建议
```
src/
├── index.js          # 主入口
├── utils/            # 工具函数
├── config/           # 配置文件
├── middleware/       # 中间件
├── routes/           # 路由
├── models/           # 数据模型
└── services/         # 业务服务
```

### 3. 导入导出风格
```javascript
// 推荐：命名导入
const { hashPassword } = require('./utils/password');

// 或：默认导出
const auth = require('./middleware/auth');
auth.requireAuth(req, res, next);
```

### 4. 错误处理
- 保持原有的错误处理逻辑
- 在新模块中添加适当的错误处理

## 拆分顺序建议

### 从小到大
1. **工具函数** (最简单)
    - 无依赖或依赖少
    - 功能独立
    - 风险最低

2. **配置模块**
    - 相对独立
    - 主要是数据初始化

3. **中间件**
    - 依赖 express
    - 功能单一

4. **路由模块**
    - 代码量大
    - 依赖较多
    - 需要仔细测试

### 优先级矩阵
| 模块类型 | 代码量 | 依赖复杂度 | 优先级 |
|---------|--------|------------|--------|
| utils/password.js | 低 | 低 | 高 |
| config/upload.js | 中 | 中 | 中 |
| routes/comments.js | 高 | 高 | 低 |

### Express 应用拆分示例
基于提供的 `src/index.js` 文件，以下是具体的拆分建议：

1. **第一步：工具函数拆分** 
    - `src/utils/password.js` - 密码哈希和验证函数 ✅ (已完成)

2. **第二步：数据库初始化拆分**
    - 创建 `src/database/init.js` - 数据库表创建和索引 ✅ (已完成)
    - 创建 `src/database/cleanup.js` - 孤儿文件清理功能 ✅ (已完成)

3. **第三步：中间件拆分**
    - 创建 `src/middleware/auth.js` - 认证中间件 ✅ (已完成)
    - 创建 `src/middleware/upload.js` - 文件上传配置 ✅ (已完成)
    - 创建 `src/middleware/session.js` - 会话配置 ✅ (已完成)

4. **第四步：路由拆分**
    - 创建 `src/routes/auth.js` - 认证相关路由 ✅ (已完成)
    - 创建 `src/routes/messages.js` - 消息相关路由 ✅ (已完成)
    - 创建 `src/routes/comments.js` - 评论相关路由 ✅ (已完成)
    - 创建 `src/routes/upload.js` - 文件上传路由 ✅ (已完成)

## 常见问题及解决方案

### 1. 变量依赖问题
**问题**：模块中使用了原文件的变量
**解决**：
```javascript
// 通过参数传递
function processData(req, config) {
  // 使用传入的参数
}

// 或返回配置对象
module.exports = function(app, db) {
  // 使用传入的依赖
};
```

### 2. 循环依赖
**问题**：A 依赖 B，B 又依赖 A
**解决**：
- 提取共同依赖到新模块 C
- 重构代码结构
- 使用事件机制解耦

### 3. 全局变量
**问题**：多个模块需要访问全局变量
**解决**：
```javascript
// config/global.js
module.exports = {
  db: null,
  app: null,
  init(appInstance, dbInstance) {
    this.app = appInstance;
    this.db = dbInstance;
  }
};

// 在主文件中初始化
globalConfig.init(app, db);
```

## 示例：密码工具函数拆分

### 原代码 (index.js)
```javascript
const bcrypt = require('bcrypt');

const hashPassword = async (password) => {
  const saltRounds = 10;
  return await bcrypt.hash(password, saltRounds);
};

const comparePassword = async (password, hash) => {
  return await bcrypt.compare(password, hash);
};
```

### 拆分后 (utils/password.js)
```javascript
const bcrypt = require('bcrypt');

/**
 * 哈希密码
 * @param {string} password - 明文密码
 * @returns {Promise<string>} - 哈希后的密码
 */
const hashPassword = async (password) => {
  const saltRounds = 10;
  return await bcrypt.hash(password, saltRounds);
};

/**
 * 验证密码
 * @param {string} password - 明文密码
 * @param {string} hash - 哈希密码
 * @returns {Promise<boolean>} - 密码是否匹配
 */
const comparePassword = async (password, hash) => {
  return await bcrypt.compare(password, hash);
};

module.exports = {
  hashPassword,
  comparePassword
};
```

### 更新后的 index.js 导入
```javascript
// 导入工具函数
const { hashPassword, comparePassword } = require('./utils/password');
```

## 自动化工具建议

1. **IDE 重构功能**
   - 使用 IDE 的"提取函数"功能
   - 自动导入依赖

2. **代码分析工具**
   - ESLint 检查未使用的变量
   - 使用依赖分析工具

3. **版本控制**
   - 每次拆分创建独立提交
   - 便于回滚和追踪

## 总结

模块拆分是一个迭代过程，建议：
1. 先拆分简单的工具函数
2. 逐步处理复杂的业务逻辑
3. 每次拆分后充分测试
4. 保持代码风格一致
5. 及时更新文档

通过系统化的拆分，可以显著提升代码的可维护性和可扩展性。